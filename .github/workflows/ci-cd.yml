name: CI

on:
  pull_request:
    types: [opened, reopened, closed, synchronize]
  workflow_dispatch:

jobs:
  run-checks:
    name: Run checks
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Get npm cache
        uses: actions/cache@v2
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-
      - run: npm ci --prefer-offline
      - run: npm run lint
      - run: npm run prettier:check
      - run: npm run build

  deploy-heroku:
    name: Deploy Heroku
    runs-on: ubuntu-latest
    needs: run-checks
    if: github.event.pull_request.merged == true && (github.base_ref == 'develop' || github.base_ref == 'main')
    env:
      HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v1
      - name: Set Develop Environment
        if: github.base_ref == 'develop'
        run: echo "ENVIRONMENT=develop" >> $GITHUB_ENV
      - name: Set Prod Environment
        if: github.base_ref == 'main'
        run: echo "ENVIRONMENT=prod" >> $GITHUB_ENV
      - name: Push to Heroku
        run: git push --force https://heroku:$HEROKU_API_KEY@git.heroku.com/memorybook-${{ env.ENVIRONMENT }}.git $GITHUB_SHA:master
